kind: pipeline
type: docker
name: TennisPoint-SFCC

concurrency:
  limit: 1

environment_develop: &env_develop
  DEV_SF_API_ID:
    from_secret: DEV_SF_API_ID
  DEV_SF_API_PWD:
    from_secret: DEV_SF_API_PWD
  DEVELOPMENT_URL : 'development-eu01-tennispoint.demandware.net'
  DEVELOPMENT_NAME: 'Development'

deploy_develop_condition: &deploy_develop_condition
  branch:
    - develop
  event:
    exclude:
      - pull_request
      - promote
  ref:
    exclude:
      - refs/tags/**

steps:
  - name: install dependencies
    image: public.ecr.aws/y1v3y6s4/node:12-buster
    volumes:
      - name: npm
        path: /node-modules
    commands:
      - npm install

  - name: webpack
    image: public.ecr.aws/y1v3y6s4/node:12-buster
    volumes:
      - name: npm
        path: /node-modules
    commands:
      - ./node_modules/.bin/webpack --env prd

  - name: linter
    image: public.ecr.aws/y1v3y6s4/node:12-buster
    volumes:
      - name: npm
        path: /node-modules
    commands:
      - ./node_modules/.bin/eslint ./cartridges
      - npm run lint:css

  - name: unit tests
    image: public.ecr.aws/y1v3y6s4/node:12-buster
    volumes:
      - name: npm
        path: /node-modules
    commands:
      - npm run test

  - name: deploy to develop
    environment:
      <<: *env_develop
    image: public.ecr.aws/y1v3y6s4/node:12-buster
    volumes:
      - name: npm
        path: /node-modules
    commands:
      - npm run copy:images
      - apt update && apt install zip
      - export VERSION="DroneBuild_${DRONE_BUILD_NUMBER}_develop"
      - echo $$VERSION
      - mv cartridges $${VERSION}
      - zip -r $${VERSION}.zip $${VERSION}
      - ./node_modules/.bin/sfcc-ci client:auth $${DEV_SF_API_ID} $${DEV_SF_API_PWD}
      - ./node_modules/.bin/sfcc-ci --debug code:deploy $${VERSION}.zip -i $${DEVELOPMENT_URL}
      - ./node_modules/.bin/sfcc-ci --debug code:activate $${VERSION} -i $${DEVELOPMENT_URL}
      - ./node_modules/.bin/sfcc-ci --debug job:run invalidate-web-cache -i $${DEVELOPMENT_URL}
    when:
      <<: *deploy_develop_condition

  - name: Send develop deploy notification to Teams
    image: public.ecr.aws/y1v3y6s4/ssubcn/base
    environment:
      URL: https://tennispointde.webhook.office.com/webhookb2/5b358d52-b3b5-4b52-b63d-38062ca35400@80f121cb-54c8-488e-987d-ebcdab6a7b23/IncomingWebhook/c51984f448954111bf9a7aebe6dc51b3/8057ac22-973b-4977-88a2-f377760606b0
      ENVIRONMENT: "Development"
      IMAGE: https://static.wixstatic.com/media/9515ad_752c7ec79aa04326a32ac0526ee2fd68~mv2.gif
      LINK1: $${DRONE_BUILD_LINK}
      LINK2: $${DRONE_COMMIT_LINK}
    commands:
      - bash bin/notifyTeams.sh "$URL" "$ENVIRONMENT" "$IMAGE" "$${DRONE_COMMIT_AUTHOR}" "$${DRONE_REPO_NAME}" "$${DRONE_COMMIT_BRANCH}" "$${DRONE_COMMIT_MESSAGE}" "$${DRONE_BUILD_STATUS}" "$LINK1" "$LINK2"
    when:
      <<: *deploy_develop_condition

  - name: Send failure notification to MT
    image: public.ecr.aws/y1v3y6s4/ssubcn/base
    environment:
      URL: https://tennispointde.webhook.office.com/webhookb2/5b358d52-b3b5-4b52-b63d-38062ca35400@80f121cb-54c8-488e-987d-ebcdab6a7b23/IncomingWebhook/c51984f448954111bf9a7aebe6dc51b3/8057ac22-973b-4977-88a2-f377760606b0
      ENVIRONMENT: "ERROR"
      IMAGE: https://c.tenor.com/EDeg5ifIrjQAAAAC/alarm-better-discord.gif
      LINK1: $${DRONE_BUILD_LINK}
      LINK2: $${DRONE_COMMIT_LINK}
    commands:
      - bash bin/notifyTeams.sh "$URL" "$ENVIRONMENT" "$IMAGE" "$${DRONE_COMMIT_AUTHOR}" "$${DRONE_REPO_NAME}" "$${DRONE_COMMIT_BRANCH}" "$${DRONE_COMMIT_MESSAGE}" "$${DRONE_FAILED_STEPS} failed!" "$LINK1" "$LINK2"
    when:
      status:
        - failure

volumes:
  - name: npm
    temp: {}
  - name: dockersock
    host:
      path: /var/run/docker.sock

---
kind: secret
name: DEV_SF_API_ID
get:
  path: arn:aws:secretsmanager:eu-central-1:338351313181:secret:tennis-point-sfcc/develop-0fgHGh
  name: DEV_SF_API_ID

---
kind: secret
name: DEV_SF_API_PWD
get:
  path: arn:aws:secretsmanager:eu-central-1:338351313181:secret:tennis-point-sfcc/develop-0fgHGh
  name: DEV_SF_API_PWD

